<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Card Learning</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=Space+Grotesk:wght@400;600&display=swap');

      :root {
        color-scheme: light;
        --bg-1: #f6efe6;
        --bg-2: #cfe8ef;
        --bg-3: #f9d9c2;
        --ink: #1f2a33;
        --muted: #5d6b74;
        --accent: #e07a5f;
        --accent-dark: #c85d43;
        --card: rgba(255, 255, 255, 0.86);
        --stroke: rgba(31, 42, 51, 0.12);
        --shadow: 0 24px 60px rgba(31, 42, 51, 0.16);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Space Grotesk", "Helvetica Neue", Arial, sans-serif;
        background: radial-gradient(circle at top left, var(--bg-2), transparent 60%),
          radial-gradient(circle at 80% 20%, var(--bg-3), transparent 55%),
          linear-gradient(140deg, var(--bg-1), #ffffff 65%);
        color: var(--ink);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: clamp(16px, 3vw, 32px);
      }

      .bg {
        position: fixed;
        inset: 0;
        overflow: hidden;
        pointer-events: none;
        z-index: 0;
      }

      .blob {
        position: absolute;
        width: clamp(220px, 40vw, 420px);
        height: clamp(220px, 40vw, 420px);
        border-radius: 50%;
        filter: blur(0px);
        opacity: 0.6;
      }

      .blob.one {
        background: #bcd9f1;
        top: -12%;
        left: -8%;
      }

      .blob.two {
        background: #f7c7a3;
        bottom: -15%;
        right: -10%;
      }

      .app {
        position: relative;
        z-index: 1;
        width: min(960px, 94vw);
      }

      header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }

      .title {
        font-size: clamp(20px, 3vw, 28px);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 600;
      }

      .subtitle {
        margin-top: 6px;
        color: var(--muted);
        font-size: 14px;
      }

      .progress {
        font-weight: 600;
        font-size: 14px;
        padding: 8px 14px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.72);
        border: 1px solid var(--stroke);
      }

      .card {
        margin-top: clamp(20px, 4vw, 32px);
        padding: clamp(22px, 4vw, 40px);
        background: var(--card);
        border-radius: 28px;
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow);
        backdrop-filter: blur(6px);
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .card-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .index-pill {
        font-weight: 600;
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(31, 42, 51, 0.06);
        letter-spacing: 0.08em;
      }

      .status {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--muted);
      }

      .sentence {
        font-family: "Fraunces", "Times New Roman", serif;
        font-size: clamp(28px, 5vw, 46px);
        line-height: 1.25;
        min-height: 3.5em;
      }

      .word {
        font: inherit;
        color: inherit;
        background: none;
        border: none;
        padding: 0;
        margin: 0;
        cursor: pointer;
        display: inline;
        text-decoration: none;
        transition: color 0.2s ease;
        line-height: inherit;
        width: auto;
        max-width: none;
        border-radius: 0;
      }

      .word:hover {
        color: var(--accent-dark);
      }

      .controls {
        margin-top: clamp(16px, 3vw, 24px);
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      button {
        border: none;
        border-radius: 999px;
        padding: 12px 20px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      button:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(31, 42, 51, 0.15);
      }

      .ghost {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid var(--stroke);
        color: var(--ink);
      }

      .primary {
        background: var(--accent);
        color: #fff;
      }

      .primary:hover {
        background: var(--accent-dark);
      }

      .hint {
        margin-top: 14px;
        text-align: center;
        font-size: 12px;
        color: var(--muted);
      }

      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(31, 42, 51, 0.6);
        color: #fff;
        font-size: 16px;
        letter-spacing: 0.08em;
        display: flex;
        align-items: center;
        justify-content: center;
        text-transform: uppercase;
        z-index: 5;
        border: none;
      }

      .hidden {
        display: none !important;
      }

      .dict-overlay {
        position: fixed;
        inset: 0;
        background: rgba(31, 42, 51, 0.45);
        display: flex;
        justify-content: flex-end;
        align-items: stretch;
        z-index: 6;
      }

      .dict-panel {
        width: min(520px, 50vw);
        height: 100%;
        background: rgba(255, 255, 255, 0.96);
        border-left: 1px solid var(--stroke);
        box-shadow: -20px 0 40px rgba(31, 42, 51, 0.2);
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .dict-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .dict-title {
        font-family: "Fraunces", "Times New Roman", serif;
        font-size: 28px;
      }

      .dict-phonetic {
        color: var(--muted);
        font-size: 14px;
      }

      .dict-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .dict-close {
        background: rgba(31, 42, 51, 0.08);
        border: none;
        border-radius: 999px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
      }

      .dict-play {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: 8px 14px;
        cursor: pointer;
        font-weight: 600;
      }

      .dict-play[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .dict-body {
        overflow-y: auto;
        padding-right: 6px;
      }

      .meaning {
        margin-bottom: 14px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(31, 42, 51, 0.08);
      }

      .meaning:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .part {
        font-weight: 600;
        margin-bottom: 6px;
      }

      .definition {
        margin-bottom: 6px;
        color: var(--ink);
      }

      .dict-note {
        color: var(--muted);
        font-size: 13px;
      }

      @media (max-width: 600px) {
        .progress {
          width: 100%;
          text-align: center;
        }

        .card {
          border-radius: 20px;
        }

        .controls button {
          width: 100%;
          max-width: 260px;
        }

        .dict-panel {
          width: 100%;
          height: 55vh;
          align-self: flex-end;
          border-left: none;
          border-top-left-radius: 20px;
          border-top-right-radius: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="bg">
      <div class="blob one"></div>
      <div class="blob two"></div>
    </div>

    <main class="app">
      <header>
        <div>
          <div class="title">Card Learning</div>
          <div class="subtitle">Auto loop audio with manual navigation.</div>
        </div>
        <div class="progress" id="progress">0 / 0</div>
      </header>

      <section class="card">
        <div class="card-top">
          <div class="index-pill" id="index">#000</div>
          <div class="status" id="status">Looping</div>
        </div>
        <div class="sentence" id="sentence">Loading...</div>
      </section>

      <div class="controls">
        <button class="ghost" id="prev">Prev</button>
        <button class="primary" id="play">Pause</button>
        <button class="ghost" id="next">Next</button>
      </div>

      <div class="hint">Use Left/Right to switch, Space to play/pause.</div>
    </main>

    <button class="overlay hidden" id="startOverlay">Tap to Start Audio</button>
    <div class="dict-overlay hidden" id="dictOverlay" aria-hidden="true">
      <div class="dict-panel" role="dialog" aria-modal="true" aria-labelledby="dictWord">
        <div class="dict-header">
          <div>
            <div class="dict-title" id="dictWord">Word</div>
            <div class="dict-phonetic" id="dictPhonetic"></div>
          </div>
          <div class="dict-actions">
            <button class="dict-play" id="dictPlay">Play</button>
            <button class="dict-close" id="dictClose">Close</button>
          </div>
        </div>
        <div class="dict-body" id="dictBody"></div>
      </div>
    </div>
    <audio id="audio" preload="auto"></audio>

    <script>
      const state = {
        items: [],
        index: 0,
        autoPlay: true,
        loop: true,
      };

      const sentenceEl = document.getElementById("sentence");
      const indexEl = document.getElementById("index");
      const progressEl = document.getElementById("progress");
      const statusEl = document.getElementById("status");
      const audio = document.getElementById("audio");
      const overlay = document.getElementById("startOverlay");
      const playBtn = document.getElementById("play");
      const prevBtn = document.getElementById("prev");
      const nextBtn = document.getElementById("next");
      const dictOverlay = document.getElementById("dictOverlay");
      const dictWordEl = document.getElementById("dictWord");
      const dictPhoneticEl = document.getElementById("dictPhonetic");
      const dictBodyEl = document.getElementById("dictBody");
      const dictPlayBtn = document.getElementById("dictPlay");
      const dictCloseBtn = document.getElementById("dictClose");

      const padId = (id) => String(id).padStart(3, "0");

      const dictCache = new Map();
      let dictAudio = new Audio();
      let dictAudioUrl = "";

      const resolveBaseUrl = () => {
        const path = window.location.pathname;
        let basePath = path;
        if (!basePath.endsWith("/")) {
          if (basePath.includes(".")) {
            basePath = basePath.slice(0, basePath.lastIndexOf("/") + 1);
          } else {
            basePath = basePath + "/";
          }
        }
        return `${window.location.origin}${basePath}`;
      };

      const segmentsBaseUrl = new URL("segments/", resolveBaseUrl());

      async function loadManifest() {
        const res = await fetch(new URL("manifest.json", segmentsBaseUrl));
        if (!res.ok) {
          throw new Error("Failed to load manifest");
        }
        const data = await res.json();
        state.items = data.items || [];
        return data;
      }

      function updateButtons() {
        playBtn.textContent = audio.paused ? "Play" : "Pause";
      }

      function renderSentence(text) {
        sentenceEl.innerHTML = "";
        const parts = text.match(/[A-Za-z]+(?:'[A-Za-z]+)?|[^A-Za-z]+/g) || [
          text,
        ];
        for (const part of parts) {
          if (/^[A-Za-z]/.test(part)) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "word";
            btn.textContent = part;
            btn.dataset.word = part;
            sentenceEl.appendChild(btn);
          } else {
            sentenceEl.appendChild(document.createTextNode(part));
          }
        }
      }

      async function loadCard(nextIndex) {
        if (!state.items.length) return;

        state.index = (nextIndex + state.items.length) % state.items.length;
        const item = state.items[state.index];

        indexEl.textContent = `#${padId(item.id)}`;
        progressEl.textContent = `${state.index + 1} / ${state.items.length}`;
        statusEl.textContent = state.loop ? "Looping" : "Single Play";
        sentenceEl.textContent = "Loading...";

        audio.pause();
        audio.currentTime = 0;
        audio.src = new URL(`${item.base}.m4a`, segmentsBaseUrl).toString();
        audio.loop = state.loop;

        try {
          const res = await fetch(new URL(`${item.base}.txt`, segmentsBaseUrl));
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }
          const text = await res.text();
          const trimmed = text.trim();
          if (!trimmed) {
            sentenceEl.textContent = "(empty)";
          } else {
            renderSentence(trimmed);
          }
        } catch (err) {
          const reason = err && err.message ? ` (${err.message})` : "";
          sentenceEl.textContent = `Failed to load text${reason}`;
        }

        if (state.autoPlay) {
          if (audio.readyState >= 2) {
            tryPlay();
          } else {
            audio.addEventListener(
              "canplay",
              () => {
                tryPlay();
              },
              { once: true }
            );
          }
        }
      }

      function tryPlay() {
        return audio
          .play()
          .then(() => {
            overlay.classList.add("hidden");
            updateButtons();
          })
          .catch(() => {
            overlay.classList.remove("hidden");
            updateButtons();
          });
      }

      function pause() {
        audio.pause();
        updateButtons();
      }

      function openDictionary() {
        if (!audio.paused) {
          pause();
        }
        dictOverlay.classList.remove("hidden");
        dictOverlay.setAttribute("aria-hidden", "false");
      }

      function closeDictionary() {
        dictOverlay.classList.add("hidden");
        dictOverlay.setAttribute("aria-hidden", "true");
      }

      function renderDefinitions(entry) {
        dictBodyEl.innerHTML = "";
        if (!entry || !entry.meanings || !entry.meanings.length) {
          dictBodyEl.innerHTML =
            '<div class="dict-note">No definitions found.</div>';
          return;
        }
        entry.meanings.forEach((meaning) => {
          const wrapper = document.createElement("div");
          wrapper.className = "meaning";
          const part = document.createElement("div");
          part.className = "part";
          part.textContent = meaning.partOfSpeech || "Meaning";
          wrapper.appendChild(part);
          (meaning.definitions || []).slice(0, 4).forEach((def) => {
            const defEl = document.createElement("div");
            defEl.className = "definition";
            defEl.textContent = def.definition;
            wrapper.appendChild(defEl);
          });
          dictBodyEl.appendChild(wrapper);
        });
      }

      function setDictionaryState({ word, phonetic, audioUrl, entry, note }) {
        dictWordEl.textContent = word || "Word";
        dictPhoneticEl.textContent = phonetic || "";
        dictAudioUrl = audioUrl || "";
        dictPlayBtn.disabled = !dictAudioUrl;
        if (note) {
          dictBodyEl.innerHTML = `<div class="dict-note">${note}</div>`;
        } else {
          renderDefinitions(entry);
        }
      }

      async function fetchDictionary(word) {
        const normalized = word.toLowerCase();
        if (dictCache.has(normalized)) {
          return dictCache.get(normalized);
        }
        const res = await fetch(
          `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(
            normalized
          )}`
        );
        if (!res.ok) {
          throw new Error(`No entry for "${word}"`);
        }
        const data = await res.json();
        dictCache.set(normalized, data);
        return data;
      }

      async function showDictionary(word) {
        openDictionary();
        setDictionaryState({
          word,
          phonetic: "",
          audioUrl: "",
          entry: null,
          note: "Loading...",
        });
        try {
          const data = await fetchDictionary(word);
          const entry = data[0];
          const phonetic =
            entry.phonetic ||
            (entry.phonetics || [])
              .map((p) => p.text)
              .find((text) => text) ||
            "";
          const audioUrl =
            (entry.phonetics || [])
              .map((p) => p.audio)
              .find((audio) => audio) || "";
          setDictionaryState({
            word: entry.word || word,
            phonetic,
            audioUrl,
            entry,
          });
        } catch (err) {
          setDictionaryState({
            word,
            phonetic: "",
            audioUrl: "",
            entry: null,
            note: "No dictionary entry found.",
          });
        }
      }

      prevBtn.addEventListener("click", () => loadCard(state.index - 1));
      nextBtn.addEventListener("click", () => loadCard(state.index + 1));
      playBtn.addEventListener("click", () => {
        if (audio.paused) {
          tryPlay();
        } else {
          pause();
        }
      });

      overlay.addEventListener("click", () => {
        state.autoPlay = true;
        tryPlay();
      });

      dictPlayBtn.addEventListener("click", () => {
        if (!dictAudioUrl) return;
        dictAudio.pause();
        dictAudio = new Audio(dictAudioUrl);
        dictAudio.play().catch(() => {});
      });

      dictCloseBtn.addEventListener("click", closeDictionary);
      dictOverlay.addEventListener("click", (event) => {
        if (event.target === dictOverlay) {
          closeDictionary();
        }
      });

      sentenceEl.addEventListener("click", (event) => {
        const target = event.target;
        if (target && target.classList.contains("word")) {
          showDictionary(target.dataset.word || target.textContent);
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "ArrowLeft") {
          loadCard(state.index - 1);
        }
        if (event.key === "ArrowRight") {
          loadCard(state.index + 1);
        }
        if (event.code === "Space") {
          event.preventDefault();
          if (audio.paused) {
            tryPlay();
          } else {
            pause();
          }
        }
        if (event.key === "Escape") {
          closeDictionary();
        }
      });

      loadManifest()
        .then(() => loadCard(0))
        .catch(() => {
          sentenceEl.textContent = "Could not load segments/manifest.json";
        });
    </script>
  </body>
</html>
